# WSUS Reporting Solution - Quick Install (ASCII ONLY VERSION)
# No Unicode characters - works on any system!

[CmdletBinding()]
param(
    [Parameter(Mandatory=$true)]
    [string]$SqlServer,
    
    [Parameter(Mandatory=$false)]
    [switch]$SetupAutomation,
    
    [Parameter(Mandatory=$false)]
    [string]$SmtpServer,
    
    [Parameter(Mandatory=$false)]
    [string]$EmailTo,
    
    [Parameter(Mandatory=$false)]
    [string]$EmailFrom
)

$ErrorActionPreference = "Stop"

# Verify running as admin
$currentPrincipal = New-Object Security.Principal.WindowsPrincipal([Security.Principal.WindowsIdentity]::GetCurrent())
$isAdmin = $currentPrincipal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)

if (-not $isAdmin) {
    Write-Error "This script must be run as Administrator."
    exit 1
}

if ($SetupAutomation) {
    if (-not $SmtpServer -or -not $EmailTo -or -not $EmailFrom) {
        Write-Error "When using -SetupAutomation, you must provide -SmtpServer, -EmailTo, and -EmailFrom"
        exit 1
    }
}

Write-Host ""
Write-Host "==============================================================" -ForegroundColor Cyan
Write-Host "       WSUS REPORTING SOLUTION - QUICK INSTALL" -ForegroundColor Cyan
Write-Host "==============================================================" -ForegroundColor Cyan
Write-Host ""

$scriptDir = Split-Path -Parent $MyInvocation.MyCommand.Path
$outputDir = "C:\WSUSReports"

Write-Host "Installation Directory: $scriptDir" -ForegroundColor Gray
Write-Host "SQL Server: $SqlServer" -ForegroundColor Gray
Write-Host "Output Directory: $outputDir" -ForegroundColor Gray
Write-Host ""

# Step 1: Verify Prerequisites
Write-Host "[1/5] Verifying prerequisites..." -ForegroundColor Cyan

Write-Host "  Testing SQL Server connection..." -ForegroundColor Gray
try {
    $connectionString = "Server=$SqlServer;Database=SUSDB;Integrated Security=True;TrustServerCertificate=True;Connection Timeout=5;"
    $connection = New-Object System.Data.SqlClient.SqlConnection($connectionString)
    $connection.Open()
    $connection.Close()
    Write-Host "  [OK] SQL Server connection successful" -ForegroundColor Green
}
catch {
    Write-Host "  [FAIL] Failed to connect to SQL Server" -ForegroundColor Red
    Write-Host "  Error: $_" -ForegroundColor Red
    Write-Host ""
    Write-Host "Troubleshooting:" -ForegroundColor Yellow
    Write-Host "  - Verify SQL Server name is correct" -ForegroundColor White
    Write-Host "  - Check firewall allows port 1433" -ForegroundColor White
    Write-Host "  - Ensure Windows Authentication is enabled" -ForegroundColor White
    Write-Host "  - Confirm SUSDB database exists" -ForegroundColor White
    exit 1
}

Write-Host "  Checking for SQL view scripts..." -ForegroundColor Gray
$sqlFiles = Get-ChildItem -Path $scriptDir -Filter "*_vw_*.sql" | Sort-Object Name

if ($sqlFiles.Count -eq 0) {
    Write-Host "  [FAIL] No SQL view scripts found in $scriptDir" -ForegroundColor Red
    Write-Host "  Make sure all .sql files are in the same folder as this script" -ForegroundColor Yellow
    exit 1
}

Write-Host "  [OK] Found $($sqlFiles.Count) SQL view scripts" -ForegroundColor Green

Write-Host "  Checking for PowerShell scripts..." -ForegroundColor Gray
$requiredScripts = @('Generate-WSUSReports.ps1', 'Test-WSUSReportingHealth.ps1')
$missingScripts = @()

foreach ($script in $requiredScripts) {
    if (-not (Test-Path (Join-Path $scriptDir $script))) {
        $missingScripts += $script
    }
}

if ($missingScripts.Count -gt 0) {
    Write-Host "  [FAIL] Missing required scripts: $($missingScripts -join ', ')" -ForegroundColor Red
    Write-Host "  Make sure all files are in the same folder" -ForegroundColor Yellow
    exit 1
}

Write-Host "  [OK] All required PowerShell scripts found" -ForegroundColor Green

if (-not (Test-Path $outputDir)) {
    New-Item -ItemType Directory -Path $outputDir -Force | Out-Null
    Write-Host "  [OK] Created output directory: $outputDir" -ForegroundColor Green
} else {
    Write-Host "  [OK] Output directory exists: $outputDir" -ForegroundColor Green
}

Write-Host ""

# Step 2: Deploy SQL Views
Write-Host "[2/5] Deploying SQL views..." -ForegroundColor Cyan

function Invoke-SqlScript {
    param([string]$FilePath, [string]$ServerInstance)
    
    try {
        $scriptContent = Get-Content -Path $FilePath -Raw
        
        $connectionString = "Server=$ServerInstance;Database=SUSDB;Integrated Security=True;TrustServerCertificate=True;"
        $connection = New-Object System.Data.SqlClient.SqlConnection($connectionString)
        $connection.Open()
        
        $command = $connection.CreateCommand()
        $command.CommandText = $scriptContent
        $command.CommandTimeout = 60
        $command.ExecuteNonQuery() | Out-Null
        
        $connection.Close()
        return $true
    }
    catch {
        Write-Host "  Error: $_" -ForegroundColor Red
        return $false
    }
}

$viewsDeployed = 0
foreach ($sqlFile in $sqlFiles) {
    Write-Host "  Deploying $($sqlFile.Name)..." -ForegroundColor Gray
    if (Invoke-SqlScript -FilePath $sqlFile.FullName -ServerInstance $SqlServer) {
        Write-Host "    [OK] Success" -ForegroundColor Green
        $viewsDeployed++
    } else {
        Write-Host "    [FAIL] Failed" -ForegroundColor Red
    }
}

if ($viewsDeployed -eq $sqlFiles.Count) {
    Write-Host "  [OK] All $viewsDeployed SQL views deployed successfully" -ForegroundColor Green
} else {
    Write-Host "  [WARNING] Only $viewsDeployed of $($sqlFiles.Count) views deployed" -ForegroundColor Yellow
}

Write-Host ""

Write-Host "==============================================================" -ForegroundColor Green
Write-Host "            INSTALLATION COMPLETE!" -ForegroundColor Green
Write-Host "==============================================================" -ForegroundColor Green
Write-Host ""

Write-Host "All scripts are in: $scriptDir" -ForegroundColor Cyan
Write-Host "Reports saved to: $outputDir" -ForegroundColor Cyan
Write-Host ""
Write-Host "Success! Your WSUS reporting system is ready." -ForegroundColor Green
Write-Host ""
